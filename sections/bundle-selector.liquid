{% comment %}
  Section: Bundle Selector (Blocks)
{% endcomment %}

<div
  class="bundle-selector-wrapper max-w-2xl mx-auto p-4"
  id="bundle-selector-{{ section.id }}"
>
  {% if section.blocks.size == 0 %}
    <div class="text-center py-12 bg-red-50 text-red-700 rounded-lg">
      <p class="font-bold">‚ö†Ô∏è Configuraci√≥n Requerida</p>
      <p>Agrega bloques de 'Pack' en el editor del tema.</p>
    </div>
  {% else %}
    <!-- Bundle Options -->
    <div class="bundles-container flex flex-col gap-4 mb-8">
      {% for block in section.blocks %}
        {% assign product = all_products[block.settings.product] %}
        {% assign variant = product.selected_or_first_available_variant %}
        {% assign title = block.settings.title | default: product.title | default: 'Pack Opci√≥n' %}

        {% if product != empty %}
          <div
            class="bundle-option relative bg-white border-2 border-transparent rounded-xl p-4 cursor-pointer transition-all duration-300 transform hover:scale-[1.01]"
            onclick="selectBundle(this, '{{ variant.id }}', {{ variant.price }})"
            data-variant-id="{{ variant.id }}"
            data-price="{{ variant.price }}"
            {{ block.shopify_attributes }}
          >
            {% if block.settings.badge_text != blank %}
              <div
                class="absolute -top-3 left-1/2 -translate-x-1/2 bg-blue-600 text-white text-xs font-bold px-3 py-1 rounded-full shadow-md z-10"
                style="background-color: {{ block.settings.badge_color }};"
              >
                {{ block.settings.badge_text }}
              </div>
            {% endif %}

            <div class="flex items-center gap-4">
              <!-- Radio Indicator -->
              <div class="radio-indicator w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center transition-colors">
                <div class="dot w-3 h-3 rounded-full bg-white opacity-0 transition-opacity"></div>
              </div>

              <!-- Info -->
              <div class="flex-1">
                <h3 class="font-bold text-lg text-gray-900">{{ title }}</h3>
                {% if block.settings.subtitle != blank %}
                  <p class="text-xs text-gray-500">{{ block.settings.subtitle }}</p>
                {% endif %}
              </div>

              <!-- Price -->
              <div class="text-right">
                {% if product.compare_at_price > product.price %}
                  <p class="text-xs text-gray-400 line-through">{{ product.compare_at_price | money }}</p>
                {% endif %}
                <p class="text-xl font-bold text-gray-900">{{ product.price | money }}</p>
              </div>
            </div>

            <!-- Hidden Input for Form Submission compliance if needed -->
            <input type="hidden" name="id" value="{{ variant.id }}" disabled>
          </div>
        {% endif %}
      {% endfor %}
    </div>

    <!-- Total Price Display & CTA -->
    <div class="border-t pt-6">
      <div class="flex justify-between items-center mb-4 text-xl font-bold">
        <span>Total:</span>
        <span id="total-price-display">$0.00</span>
      </div>

      <button
        id="add-to-cart-btn"
        class="w-full bg-black text-white text-lg font-bold py-4 rounded-xl shadow-lg hover:shadow-xl hover:scale-[1.02] transition-all disabled:opacity-50 disabled:cursor-not-allowed relative overflow-hidden group"
        onclick="addToCart()"
        disabled
      >
        <span class="relative z-10">AGREGAR AL CARRITO</span>
        <div
          class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"
        ></div>
      </button>

      <div class="flex justify-center gap-4 mt-4 text-xs text-gray-500">
        <span>üîí Pago Seguro</span>
        <span>‚ö° Env√≠o R√°pido</span>
      </div>
    </div>
  {% endif %}
</div>

<style>
  .bundle-option.active-pack {
    border-color: black;
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); /* shadow-high */
    transform: scale(1.03);
  }
  .bundle-option.active-pack .radio-indicator {
    border-color: black;
    background-color: black;
  }
  .bundle-option.active-pack .radio-indicator .dot {
    opacity: 1;
  }
</style>

<script>
  let selectedVariantId = null;

  function selectBundle(element, variantId, priceCents) {
    // Styling
    document.querySelectorAll('.bundle-option').forEach((el) => el.classList.remove('active-pack'));
    element.classList.add('active-pack');

    // Logic
    selectedVariantId = variantId;

    // Update Price
    const moneyFormat = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }); // Simplified for demo
    // Ideally use Shopifys Money Format formatMoney(priceCents, "{{ shop.money_format }}")
    // For now simple formatter:
    document.getElementById('total-price-display').innerText = (priceCents / 100).toLocaleString('en-US', {
      style: 'currency',
      currency: 'USD',
    });

    // Enable Button
    document.getElementById('add-to-cart-btn').disabled = false;
  }

  function addToCart() {
    if (!selectedVariantId) return;

    const btn = document.getElementById('add-to-cart-btn');
    const originalText = btn.innerHTML;

    btn.innerHTML = '<span class="relative z-10">PROCESANDO...</span>';
    btn.disabled = true;

    const items = [
      {
        id: selectedVariantId,
        quantity: 1,
      },
    ];

    fetch(window.Shopify.routes.root + 'cart/add.js', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ items }),
    })
      .then((response) => response.json())
      .then((data) => {
        // Redirect to checkout or open drawer
        window.location.href = '/checkout';
      })
      .catch((error) => {
        console.error('Error:', error);
        btn.innerHTML = '<span class="relative z-10">ERROR</span>';
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.disabled = false;
        }, 2000);
      });
  }
</script>

{% schema %}
{
  "name": "Bundle Selector (Blocks)",
  "settings": [
    {
      "type": "header",
      "content": "Bundle Configuration"
    }
  ],
  "blocks": [
    {
      "type": "pack",
      "name": "Pack Option",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Display Title",
          "info": "Overrides product title"
        },
        {
          "type": "text",
          "id": "subtitle",
          "label": "Subtitle",
          "default": "Ahorra un 10%"
        },
        {
          "type": "text",
          "id": "badge_text",
          "label": "Badge Text (Optional)",
          "default": "MEJOR VALOR"
        },
        {
          "type": "color",
          "id": "badge_color",
          "label": "Badge Color",
          "default": "#2563EB"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Bundle Selector (Blocks)",
      "blocks": [
        { "type": "pack", "settings": { "badge_text": "" } },
        { "type": "pack", "settings": { "badge_text": "M√ÅS VENDIDO" } },
        { "type": "pack", "settings": { "badge_text": "MAYOR AHORRO" } }
      ]
    }
  ]
}
{% endschema %}

{% assign target_product = all_products[section.settings.product_ref] | default: product %}

<div
  class="bundle-selector-wrapper max-w-2xl mx-auto"
  data-product-price="{{ target_product.price | default: 0 }}"
  style="padding: 1rem;"
>
  {% if target_product == empty %}
    <div class="text-center py-12" style="background: #fee2e2; border-radius: 8px; padding: 1rem; color: #b91c1c;">
      <p class="font-bold">‚ö†Ô∏è Configuraci√≥n Requerida</p>
      <p>Selecciona un producto en el editor del tema para mostrar las opciones.</p>
    </div>
  {% else %}
    <!-- Bundle Options -->
    <div class="bundles-container mb-6">
      {% for variant in target_product.variants limit: 3 %}
        {% assign discount_pct = 0 %}
        {% if variant.compare_at_price > variant.price %}
          {% assign savings = variant.compare_at_price | minus: variant.price %}
          {% assign discount_pct = savings | times: 100.0 | divided_by: variant.compare_at_price | round %}
        {% endif %}

        <div
          class="bundle-option {% if forloop.index == 2 %}active{% endif %}"
          onclick="selectBundle('{{ variant.id }}', {{ variant.price | divided_by: 100.00 }})"
          id="bundle-{{ variant.id }}"
          data-variant-id="{{ variant.id }}"
        >
          {% if forloop.index == 2 %}
            <div class="bundle-badge" style="background-color: var(--color-blue-600)">M√ÅS POPULAR</div>
          {% elsif forloop.index == 3 %}
            <div class="bundle-badge" style="background-color: var(--color-green-600)">MEJOR VALOR</div>
          {% endif %}

          <div class="flex items-center gap-4">
            <div class="radio-circle"><div class="radio-dot"></div></div>

            <div class="flex-1">
              <div class="flex items-center gap-2">
                <h3 class="font-bold text-lg">{{ variant.title }}</h3>
                {% if discount_pct > 0 %}
                  <span
                    class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-bold"
                    style="background:var(--color-red-100); color:var(--color-red-700)"
                    >AHORRA {{ discount_pct }}%</span
                  >
                {% endif %}
              </div>

              {% comment %} Mocking "price per unit" logic for demo {% endcomment %}
              {% if variant.title contains '2' %}
                <p class="text-sm text-gray-500">{{ variant.price | divided_by: 2 | money }} por unidad</p>
              {% elsif variant.title contains '3' %}
                <p class="text-sm text-gray-500">{{ variant.price | divided_by: 3 | money }} por unidad</p>
              {% endif %}
            </div>

            <div class="text-right">
              {% if variant.compare_at_price > variant.price %}
                <p class="text-sm text-gray-400 line-through">{{ variant.compare_at_price | money }}</p>
              {% endif %}
              <p class="text-2xl font-bold">{{ variant.price | money }}</p>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- Upsells -->
    {% if section.settings.show_upsell %}
      <div class="upsells-container mb-6">
        <h3 class="font-bold text-lg flex items-center gap-2 mb-3">
          <span>‚ú®</span> {{ section.settings.upsell_heading }}
        </h3>

        <!-- Upsell Item -->
        <div
          class="upsell-box"
          onclick="this.classList.toggle('active'); toggleUpsell('{{ section.settings.upsell_product }}')"
          id="upsell-toggle"
          data-upsell-id="{{ all_products[section.settings.upsell_product].selected_or_first_available_variant.id }}"
        >
          <div class="flex items-center gap-4">
            <div class="checkbox-square">
              <svg
                class="w-4 h-4 text-white"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                style="width:16px; color:white;"
              >
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
            </div>
            <div class="flex-1">
              <h4 class="font-bold">{{ section.settings.upsell_title }}</h4>
              <p class="text-sm text-gray-500">{{ section.settings.upsell_desc }}</p>
            </div>
            <div class="text-right">
              {% if section.settings.upsell_price == blank or section.settings.upsell_price == '0' %}
                <p class="text-lg font-bold text-green-600" style="color:var(--color-green-600)">GRATIS</p>
              {% else %}
                <p class="text-lg font-bold">{{ section.settings.upsell_price }}</p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    {% endif %}

    <!-- CTA Button -->
    <button class="btn-primary" onclick="checkout()">
      <div class="btn-shimmer"></div>
      <span class="relative z-10" id="cta-text">AGREGAR AL CARRITO</span>
    </button>

    <!-- Trust Badges -->
    <div class="flex justify-center gap-6 mt-6 text-sm text-gray-600">
      <div class="flex items-center gap-2"><span>üõ°Ô∏è</span> Env√≠o Gratis</div>
      <div class="flex items-center gap-2"><span>üîí</span> Pago Seguro</div>
      <div class="flex items-center gap-2"><span>‚úÖ</span> 30 D√≠as Garant√≠a</div>
    </div>
  {% endif %}
</div>

<script>
  let upsellVariantId = null;

  function toggleUpsell(productId) {
    const el = document.getElementById('upsell-toggle');
    if (el.classList.contains('active')) {
      upsellVariantId = el.dataset.upsellId;
    } else {
      upsellVariantId = null;
    }
  }

  function checkout() {
    // Safe lookup for variant ID
    const activeOption = document.querySelector('.bundle-option.active');
    if (!activeOption) {
      alert('Por favor selecciona una opci√≥n.');
      return;
    }

    const variantId = activeOption.dataset.variantId;

    // items array
    const items = [{ id: variantId, quantity: 1 }];

    // Add upsell if selected and valid
    if (upsellVariantId) {
      items.push({ id: upsellVariantId, quantity: 1 });
    }

    // Add to cart
    const btn = document.querySelector('.btn-primary');
    const originalText = document.getElementById('cta-text').innerText;
    document.getElementById('cta-text').innerText = 'PROCESANDO...';

    fetch('/cart/add.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ items: items }),
    })
      .then(() => (window.location.href = '/checkout'))
      .catch((e) => {
        alert('Error adding to cart: ' + e);
        document.getElementById('cta-text').innerText = originalText;
      });
  }
</script>

{% schema %}
{
  "name": "Bundle Selector React",
  "settings": [
    {
      "type": "product",
      "id": "product_ref",
      "label": "Select Main Product",
      "info": "Assign the product to display variants from."
    },
    {
      "type": "header",
      "content": "Upsell Settings"
    },
    {
      "type": "checkbox",
      "id": "show_upsell",
      "label": "Enable Upsell",
      "default": true
    },
    {
      "type": "text",
      "id": "upsell_heading",
      "label": "Upsell Section Heading",
      "default": "A√±ade valor a tu pedido"
    },
    {
      "type": "product",
      "id": "upsell_product",
      "label": "Upsell Product (Optional)"
    },
    {
      "type": "text",
      "id": "upsell_title",
      "label": "Upsell Title",
      "default": "E-book Exclusivo"
    },
    {
      "type": "text",
      "id": "upsell_desc",
      "label": "Upsell Description",
      "default": "Gu√≠a completa de uso y mantenimiento"
    },
    {
      "type": "text",
      "id": "upsell_price",
      "label": "Display Price Text",
      "default": "GRATIS",
      "info": "Use specific amount or 'GRATIS'"
    }
  ],
  "presets": [{ "name": "Bundle Selector React" }]
}
{% endschema %}
