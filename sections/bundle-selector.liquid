{% comment %}
  Section: Bundle Selector (Based on React Component)
{% endcomment %}

{% assign target_product = all_products[section.settings.product_ref] | default: product %}

<div
  class="bundle-selector-wrapper max-w-2xl mx-auto"
  data-product-price="{{ target_product.price | default: 0 }}"
  style="padding: 1rem;"
>
  {% if target_product == empty %}
    <div class="text-center py-12" style="background: #fee2e2; border-radius: 8px; padding: 1rem; color: #b91c1c;">
      <p class="font-bold">‚ö†Ô∏è Configuraci√≥n Requerida</p>
      <p>Selecciona un producto en el editor del tema para mostrar las opciones.</p>
    </div>
  {% else %}
    <!-- Bundle Options -->
    <div class="bundles-container mb-6">
      {% for variant in target_product.variants limit: 3 %}
        {% assign discount_pct = 0 %}
        {% if variant.compare_at_price > variant.price %}
          {% assign savings = variant.compare_at_price | minus: variant.price %}
          {% assign discount_pct = savings | times: 100.0 | divided_by: variant.compare_at_price | round %}
        {% endif %}

        <div
          class="bundle-option {% if forloop.index == 2 %}active{% endif %}"
          onclick="selectBundle('{{ variant.id }}', {{ variant.price | divided_by: 100.00 }})"
          id="bundle-{{ variant.id }}"
          data-variant-id="{{ variant.id }}"
        >
          {% if forloop.index == 2 %}
            <div class="bundle-badge" style="background-color: var(--color-blue-600)">M√ÅS POPULAR</div>
          {% elsif forloop.index == 3 %}
            <div class="bundle-badge" style="background-color: var(--color-green-600)">MEJOR VALOR</div>
          {% endif %}

          <div class="flex items-center gap-4">
            <div class="radio-circle"><div class="radio-dot"></div></div>

            <div class="flex-1">
              <div class="flex items-center gap-2">
                <h3 class="font-bold text-lg">{{ variant.title }}</h3>
                {% if discount_pct > 0 %}
                  <span
                    class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-bold"
                    style="background:var(--color-red-100); color:var(--color-red-700)"
                    >AHORRA {{ discount_pct }}%</span
                  >
                {% endif %}
              </div>

              {% comment %} Mocking "price per unit" logic for demo {% endcomment %}
              {% if variant.title contains '2' %}
                <p class="text-sm text-gray-500">{{ variant.price | divided_by: 2 | money }} por unidad</p>
              {% elsif variant.title contains '3' %}
                <p class="text-sm text-gray-500">{{ variant.price | divided_by: 3 | money }} por unidad</p>
              {% endif %}
            </div>

            <div class="text-right">
              {% if variant.compare_at_price > variant.price %}
                <p class="text-sm text-gray-400 line-through">{{ variant.compare_at_price | money }}</p>
              {% endif %}
              <p class="text-2xl font-bold">{{ variant.price | money }}</p>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- Upsells -->
    <div class="upsells-container mb-6">
      <h3 class="font-bold text-lg flex items-center gap-2 mb-3"><span>‚ú®</span> A√±ade valor a tu pedido</h3>

      <!-- Upsell 1 -->
      <div class="upsell-box" onclick="this.classList.toggle('active')" id="upsell-ebook">
        <div class="flex items-center gap-4">
          <div class="checkbox-square">
            <svg
              class="w-4 h-4 text-white"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              style="width:16px; color:white;"
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
          </div>
          <div class="flex-1">
            <h4 class="font-bold">E-book Exclusivo</h4>
            <p class="text-sm text-gray-500">Gu√≠a completa de uso y mantenimiento</p>
          </div>
          <div class="text-right">
            <p class="text-lg font-bold text-green-600" style="color:var(--color-green-600)">GRATIS</p>
          </div>
        </div>
      </div>
    </div>

    <!-- CTA Button -->
    <button class="btn-primary" onclick="checkout()">
      <div class="btn-shimmer"></div>
      <span class="relative z-10" id="cta-text">AGREGAR AL CARRITO</span>
    </button>

    <!-- Trust Badges -->
    <div class="flex justify-center gap-6 mt-6 text-sm text-gray-600">
      <div class="flex items-center gap-2"><span>üõ°Ô∏è</span> Env√≠o Gratis</div>
      <div class="flex items-center gap-2"><span>üîí</span> Pago Seguro</div>
      <div class="flex items-center gap-2"><span>‚úÖ</span> 30 D√≠as Garant√≠a</div>
    </div>
  {% endif %}
</div>

<script>
  function selectBundle(id, price) {
    // Visual Update
    document.querySelectorAll('.bundle-option').forEach((el) => el.classList.remove('active'));
    document.getElementById(`bundle-${id}`).classList.add('active');

    // Update Button Text
    const btn = document.getElementById('cta-text');
    if (btn) btn.innerText = `AGREGAR AL CARRITO - ${price.toFixed(2)}‚Ç¨`;
  }

  function checkout() {
    // Safe lookup for variant ID
    const activeOption = document.querySelector('.bundle-option.active');
    if (!activeOption) {
      alert('Por favor selecciona una opci√≥n.');
      return;
    }

    const variantId = activeOption.dataset.variantId;

    // Add to cart
    const btn = document.querySelector('.btn-primary');
    const originalText = document.getElementById('cta-text').innerText;
    document.getElementById('cta-text').innerText = 'PROCESANDO...';

    fetch('/cart/add.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ items: [{ id: variantId, quantity: 1 }] }),
    })
      .then(() => (window.location.href = '/checkout'))
      .catch((e) => {
        alert('Error adding to cart: ' + e);
        document.getElementById('cta-text').innerText = originalText;
      });
  }
</script>

{% schema %}
{
  "name": "Bundle Selector React",
  "settings": [
    {
      "type": "product",
      "id": "product_ref",
      "label": "Select Main Product",
      "info": "Assign the product to display variants from."
    }
  ],
  "presets": [{ "name": "Bundle Selector React" }]
}
{% endschema %}
